## Pipeline & LLM Gateway 測試報告 (2025-10-18)

### 1. 測試目標
- 驗證 Master 在 **Pipeline 模式** 下於無 Finalizer (Worker-D) 時，能依序調用 `worker-a → worker-b → worker-c`。
- 驗證啟動 Worker-D 後，Master 能動態插入 `finalize` stage (`worker-d`) 並回傳四段結果。
- 驗證在 `LLM_PROVIDER=gemini`、`GEMINI_MODEL=models/gemini-2.0-flash`、`GEMINI_API_KEY=…JnL0` 下，整條管線可使用 Gemini API 取得回應。

### 2. 測試環境
- 指令：
  ```bash
  export LLM_PROVIDER=gemini
  export GEMINI_MODEL=models/gemini-2.0-flash
  export GEMINI_API_KEY="...JnL0"
  docker compose up --build -d
  ```
- 服務：master-agent、llm-gateway、redis、worker-a/b/c/d。

### 3. 測試案例與結果

#### Case A：僅 A/B/C 在線
- **請求**
  ```json
  {"task_id":"T-300","objective":"安排週末在台北吃什麼","context":{}}
  ```
- **回應摘要**（僅保留段落開頭，完整請見 JSON 附錄）
  | Stage | Agent | Provider | 內容重點 |
  |-------|-------|----------|----------|
  | analyze | worker-a | mock | 提示使用者提供偏好資訊 |
  | retrieve | worker-b | mock | 列出需蒐集的條件（預算、時段、氛圍…） |
  | evaluate | worker-c | mock | 說明後續評估方向 |
- **結果**：僅有三個 stage，符合預期。

#### Case B：啟動 Worker-D 後
- `docker compose up --build worker-d -d`
- **請求**（同上，`task_id=T-301`）
- **回應摘要**
  | Stage | Agent | Provider | 內容重點 |
  |-------|-------|----------|----------|
  | analyze | worker-a | mock | 同上 |
  | retrieve | worker-b | mock | 同上 |
  | evaluate | worker-c | mock | 同上 |
  | finalize | worker-d | mock | 彙整前述結果，產生建議 |
- **結果**：新增 Finalizer，管線自動延伸為四段。

#### Case C：Gemini 模式完整測試
- 使用同一環境，重新啟動 docker compose。
- **請求** (`task_id=T-400`)
  ```json
  {"task_id":"T-400","objective":"幫我安排週末在台北吃什麼","context":{}}
  ```
- **回應摘要**
  | Stage | Agent | Provider | 重點 |
  |-------|-------|----------|------|
  | analyze | worker-a | gemini | Gemini 生成自然語言詢問偏好 |
  | retrieve | worker-b | gemini | Gemini 再次確認細節 |
  | evaluate | worker-c | gemini | 文字描述評估建議 |
  | finalize | worker-d | gemini | 整合出完整的推薦說明 |
- **結果**：整條管線成功使用 Gemini API 產出中文建議。

#### Case D：Worker-D 停用後即時調用（觀察）
- `docker compose stop worker-d`
- 立即送出新任務 `T-302` 時，Master 仍以舊路由調度至 `worker-d`，造成 `httpx.ConnectError`。
- **結論**：需在 pipeline 中為 Finalizer 增加「可用性檢查 / 重試 / 快取淘汰」邏輯，以避免停用當下因快取造成一次性錯誤。

### 4. 完整輸入 / 輸出範例

#### Case A 請求
```json
{"task_id":"T-300","objective":"安排週末在台北吃什麼","context":{}}
```

#### Case A 回應（節錄）
```json
{"task_id":"T-300","stages":[{"stage":"analyze","agent_id":"worker-a","status":"succeeded","output":{"provider":"mock","text":"MOCK RESPONSE..."}}, ...], "final_output":{...}}
```

#### Case C 請求
```json
{"task_id":"T-400","objective":"幫我安排週末在台北吃什麼","context":{}}
```

#### Case C 回應（完整節錄）

- **Stage: analyze (worker-a, provider=gemini)**

  ```text
  好的，我很樂意幫您規劃台北週末的美食行程。台北以其多元且美味的食物聞名，從傳統小吃到國際料理應有盡有。

  為了提供最符合您喜好與需求的建議，我需要一些額外的資訊。如果您能提供以下細節，我將能為您做出更精準的分析與規劃：

  1.  **飲食偏好**：
      *   您偏好台灣在地小吃、傳統台菜、異國料理（例如日式、韓式、西式）還是融合菜？
      *   是否有特別喜歡或不喜歡的食材/口味（例如：辣、甜、素食、海鮮、內臟）？
      *   對米其林推薦餐廳、特色咖啡廳、夜市小吃或一般在地餐館是否有偏好？
  2.  **同行人數與場合**：
      *   是單人、情侶、家人（有小孩嗎？）、還是朋友聚會？
      *   希望是輕鬆隨意的用餐，還是氣氛較好的正式餐廳？
  3.  **預算考量**：
      *   每個餐期的預算大約為何？（例如：平價、中等、高價位）
  4.  **活動區域**：
      *   週末是否有預計前往的特定區域或景點？（例如：信義區、大安區、士林、淡水等）
      *   住宿地點在哪裡？
  5.  **週末天數與餐期**：
      *   是週六與週日兩天嗎？希望涵蓋哪些餐期（早餐、午餐、下午茶、晚餐、宵夜）？

  ---

  **在您提供更多資訊之前，我先為您提供一個經典的「台北週末美食初體驗」範例，涵蓋一些最受歡迎的選項：**

  ---

  ### **台北週末美食建議 (範例)**

  #### **週六**

  *   **早餐：經典台式早餐**
      *   **選項一：阜杭豆漿 (華山市場)**：排隊名店，推薦厚燒餅夾蛋油條、鹹豆漿。體驗在地人排隊美食的樂趣。
      *   **選項二：永和豆漿大王**：分布廣泛，選擇多樣，燒餅油條、蛋餅、蘿蔔糕都是經典。
  *   **午餐：台北必吃 – 滷肉飯與牛肉麵**
      *   **選項一：金峰魯肉飯 (中正紀念堂附近)**：米其林推薦，小碗滷肉飯搭配筍絲與綜合羹湯，是道地的台味。
      *   **選項二：永康牛肉麵 (永康街)**：老字號川味牛肉麵，湯頭濃郁，牛肉軟嫩，非常受歡迎。
  *   **下午茶/點心：悠閒咖啡時光 或 冰品**
      *   **選項一：青田街/永康街咖啡廳**：選擇一家有特色的小店，享受台北的文藝氣息。
      *   **選項二：思慕昔冰品 (永康街)**：品嚐知名的芒果冰或草莓冰。
  *   **晚餐：夜市美食探險**
      *   **選項一：饒河街觀光夜市 (松山車站旁)**：胡椒餅、藥燉排骨、臭豆腐、蚵仔煎等，應有盡有，是體驗台灣夜市文化的絕佳地點。
      *   **選項二：寧夏夜市 (捷運雙連站/中山站附近)**：以「圓環小吃」聞名，有許多傳統攤位，例如方家雞肉飯、劉芋仔蛋黃芋餅。

  #### **週日**

  *   **早餐：特色台味早餐 或 輕鬆早午餐**
      *   **選項一：飯糰 / 潤餅**：在街邊尋找傳統早餐攤位，品嚐飽足又道地的飯糰或潤餅。
      *   **選項二：文青咖啡早午餐**：在大安區或中山區，選擇一家氛圍好的咖啡廳享用西式或創意早午餐。
  *   **午餐：國際級台灣美食 – 小籠包**
      *   **選項一：鼎泰豐 (信義店/101店)**：全球知名的米其林一星餐廳，必點小籠包、排骨蛋炒飯、蝦肉紅油抄手。建議避開用餐高峰時段或提早預約。
      *   **選項二：杭州小籠湯包 (中正紀念堂附近)**：也是廣受好評的小籠包店家，CP值高，選擇多樣。
  *   **下午茶/點心：手搖飲與特色甜點**
      *   **選項一：春水堂 (微風南山店或其他分店)**：珍珠奶茶的發源地，可以在這裡品嚐到經典滋味，並搭配一些點心。
      *   **選項二：芋圓冰/豆花**：例如東區粉圓或任何一家在地甜品店。
  *   **晚餐：台菜海鮮熱炒 或 火鍋**
      *   **選項一：台式熱炒店**：感受台灣特有的熱鬧氛圍，點幾道下飯的菜配啤酒，例如三杯雞、客家小炒、鳳梨蝦球。
      *   **選項二：特色火鍋**：例如麻辣鍋（鼎王、老四川）或個人涮涮鍋，在寒冷的天氣中特別受歡迎。

  ---

  請告訴我您的詳細需求，我會為您量身打造一個專屬的台北美食之旅！
  ```

- **Stage: retrieve (worker-b, provider=gemini)**

  ```text
  好的，我很樂意為您在台北規劃一趟精彩的週末美食之旅！

  上一個步驟我已經為您提供了「台北週末美食初體驗」的範例，涵蓋了許多受歡迎的經典選項。

  為了能更精準地為您量身打造最符合您喜好與需求的建議，請您撥冗提供以下資訊：

  1.  **飲食偏好**：
      *   您偏好台灣在地小吃、傳統台菜、異國料理（例如日式、韓式、西式）還是融合菜？
      *   是否有特別喜歡或不喜歡的食材/口味（例如：辣、甜、素食、海鮮、內臟）？
      *   對米其林推薦餐廳、特色咖啡廳、夜市小吃或一般在地餐館是否有偏好？
  2.  **同行人數與場合**：
      *   是單人、情侶、家人（有小孩嗎？）、還是朋友聚會？
      *   希望是輕鬆隨意的用餐，還是氣氛較好的正式餐廳？
  3.  **預算考量**：
      *   每個餐期的預算大約為何？（例如：平價、中等、高價位）
  4.  **活動區域**：
      *   週末是否有預計前往的特定區域或景點？（例如：信義區、大安區、士林、淡水等）
      *   住宿地點在哪裡？
  5.  **週末天數與餐期**：
      *   是週六與週日兩天嗎？希望涵蓋哪些餐期（早餐、午餐、下午茶、晚餐、宵夜）？

  您提供的資訊越詳細，我就能為您規劃出越滿意的台北美食行程！期待您的回覆。
  ```

- **Stage: evaluate (worker-c, provider=gemini)**

  ```text
  評估型子代理審查：

  **正確性 (Correctness)**：
  *   回應中提及的餐廳和美食選項皆為台北知名且廣受好評的店家或特色餐點，資訊正確。
  *   對於「金峰魯肉飯」和「鼎泰豐」的米其林推薦描述也是正確的。
  *   各個地點的描述和特色（如阜杭州漿的排隊、永康牛肉麵的濃郁湯頭、饒河街夜市的多元小吃等）皆符合實際情況。
  *   「春水堂」作為珍珠奶茶發源地的說法也是普遍認知。

  **清晰度 (Clarity)**：
  *   回應的結構非常清晰，分為「提問」和「範例行程」兩大部分。
  *   提問部分使用編號和粗體字標示，條理分明，易於理解使用者需要提供的資訊。
  *   範例行程則按「週六」和「週日」區分，每個餐期都提供兩種不同的選項，讓使用者有更多選擇空間，排版整潔，閱讀體驗良好。
  *   語言流暢，沒有語法或錯別字問題。

  **完整性 (Completeness)**：
  *   回應充分滿足了任務目標「幫我安排週末在台北吃什麼」。策略為：
      1.  **資訊蒐集完整** — 提出飲食偏好、預算、同行人數、活動區域、餐期等關鍵問題。
      2.  **提供具體範例** — 等待使用者回覆期間，呈現一份完整的週末範例行程。

  **信心指標 (Confidence Score)**：5/5

  **總結**：
  行程建議非常全面，兼顧資訊蒐集與立即可用的範例，展現高可用性與前瞻性。
  ```

- **Stage: finalize (worker-d, provider=gemini)**

  ```text
  太棒了！為您安排台北週末美食之旅的規劃，已經經過詳細評估，結果非常令人滿意。

  以下是為您整理的友善、具體且可執行的建議：

  ### 🍽️ 台北週末美食探險，美味攻略！

  您已經獲得一份涵蓋台北經典早餐、午餐、下午茶、晚餐甚至夜市小吃的週末行程。從排隊名店阜杭豆漿、米其林推薦的金峰魯肉飯與鼎泰豐小籠包，到特色夜市小吃（饒河街、寧夏），以及文青咖啡廳與手搖飲發源地春水堂，都幫您設想周全。

  **💡 下一步：客製化資訊**
  - 告訴我喜歡哪種口味、用餐預算、同行對象與活動區域。
  - 指定想去的景點或想加上的餐期（週末早午餐、宵夜等）。

  **馬上行動！**
  - 先照範例行程走一輪，就能體驗台北經典美食。
  - 若想進一步優化，回覆您的偏好，我可以提供更貼近您胃口的個人化安排。

  祝您週末美食之旅愉快！
  ```

### 5. 後續建議
1. 在 Pipeline 中加入 Worker 可用性檢查：當 Redis `routing` 還留有離線 agent 時，應對 `ConnectError` 進行重試或直接跳過 Finalizer。
2. 建立自動化測試腳本（含 Docker Compose up/down）驗證 A→B→C 與 A→B→C→D 兩種情境。
3. 在文件中提醒使用者：切換 Provider 至 Gemini 或 Bedrock 時，需設定正確的 `GEMINI_MODEL` / `BEDROCK_MODEL_ID`。

---
